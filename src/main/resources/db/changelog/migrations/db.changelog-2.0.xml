<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.9.xsd">

    <!-- Tabela Client -->
    <changeSet id="2.0-create-client-table" author="gobarber">
        <createTable tableName="client">
            <column name="id_client" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="email" type="VARCHAR(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="phone" type="VARCHAR(20)"/>
            <column name="cpf" type="VARCHAR(14)">
                <constraints unique="true"/>
            </column>
            <column name="birth_date" type="DATE"/>
            <column name="gender" type="VARCHAR(20)"/>
            <column name="photo" type="BYTEA"/>
            <column name="preferred_contact_method" type="VARCHAR(20)"/>
            <column name="receive_promotions" type="BOOLEAN" defaultValueBoolean="true"/>
            <column name="receive_reminders" type="BOOLEAN" defaultValueBoolean="true"/>
            <column name="loyalty_points" type="INTEGER" defaultValueNumeric="0"/>
            <column name="loyalty_tier" type="VARCHAR(20)" defaultValue="BRONZE"/>
            <column name="total_visits" type="INTEGER" defaultValueNumeric="0"/>
            <column name="total_spent" type="DECIMAL(10,2)" defaultValueNumeric="0.00"/>
            <column name="last_visit_date" type="TIMESTAMP"/>
            <column name="notes" type="TEXT"/>
            <column name="is_active" type="BOOLEAN" defaultValueBoolean="true"/>
            <column name="preferred_barber_id" type="INTEGER"/>
            <column name="address_id" type="INTEGER"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="client" baseColumnNames="preferred_barber_id"
                                 constraintName="fk_client_preferred_barber"
                                 referencedTableName="barber" referencedColumnNames="id_barber"/>
        <addForeignKeyConstraint baseTableName="client" baseColumnNames="address_id"
                                 constraintName="fk_client_address"
                                 referencedTableName="address" referencedColumnNames="id_adress"/>
    </changeSet>

    <!-- Tabela Payment -->
    <changeSet id="2.0-create-payment-table" author="gobarber">
        <createTable tableName="payment">
            <column name="id_payment" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="appointment_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="amount" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
            <column name="discount" type="DECIMAL(10,2)" defaultValueNumeric="0.00"/>
            <column name="discount_reason" type="VARCHAR(255)"/>
            <column name="final_amount" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
            <column name="tip" type="DECIMAL(10,2)" defaultValueNumeric="0.00"/>
            <column name="payment_method" type="VARCHAR(30)">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(30)" defaultValue="PENDING">
                <constraints nullable="false"/>
            </column>
            <column name="transaction_id" type="VARCHAR(255)"/>
            <column name="payment_date" type="TIMESTAMP"/>
            <column name="commission_rate" type="DECIMAL(5,2)"/>
            <column name="commission_amount" type="DECIMAL(10,2)"/>
            <column name="refund_amount" type="DECIMAL(10,2)"/>
            <column name="refund_reason" type="VARCHAR(255)"/>
            <column name="refund_date" type="TIMESTAMP"/>
            <column name="notes" type="TEXT"/>
            <column name="pix_code" type="VARCHAR(500)"/>
            <column name="installments" type="INTEGER" defaultValueNumeric="1"/>
            <column name="loyalty_points_earned" type="INTEGER" defaultValueNumeric="0"/>
            <column name="loyalty_points_used" type="INTEGER" defaultValueNumeric="0"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="payment" baseColumnNames="appointment_id"
                                 constraintName="fk_payment_appointment"
                                 referencedTableName="appointment" referencedColumnNames="id_appointment"/>
    </changeSet>

    <!-- Tabela Review -->
    <changeSet id="2.0-create-review-table" author="gobarber">
        <createTable tableName="review">
            <column name="id_review" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="appointment_id" type="BIGINT">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="client_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="barber_id" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="rating" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="service_rating" type="INTEGER"/>
            <column name="punctuality_rating" type="INTEGER"/>
            <column name="cleanliness_rating" type="INTEGER"/>
            <column name="value_rating" type="INTEGER"/>
            <column name="comment" type="TEXT"/>
            <column name="would_recommend" type="BOOLEAN" defaultValueBoolean="true"/>
            <column name="reply" type="TEXT"/>
            <column name="reply_date" type="TIMESTAMP"/>
            <column name="is_visible" type="BOOLEAN" defaultValueBoolean="true"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="review" baseColumnNames="appointment_id"
                                 constraintName="fk_review_appointment"
                                 referencedTableName="appointment" referencedColumnNames="id_appointment"/>
        <addForeignKeyConstraint baseTableName="review" baseColumnNames="client_id"
                                 constraintName="fk_review_client"
                                 referencedTableName="client" referencedColumnNames="id_client"/>
        <addForeignKeyConstraint baseTableName="review" baseColumnNames="barber_id"
                                 constraintName="fk_review_barber"
                                 referencedTableName="barber" referencedColumnNames="id_barber"/>
    </changeSet>

    <!-- Tabela BarberSchedule -->
    <changeSet id="2.0-create-barber-schedule-table" author="gobarber">
        <createTable tableName="barber_schedule">
            <column name="id_schedule" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="barber_id" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="schedule_type" type="VARCHAR(30)">
                <constraints nullable="false"/>
            </column>
            <column name="start_date_time" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="end_date_time" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="reason" type="VARCHAR(255)"/>
            <column name="is_recurring" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="day_of_week" type="VARCHAR(20)"/>
            <column name="start_time" type="TIME"/>
            <column name="end_time" type="TIME"/>
            <column name="is_active" type="BOOLEAN" defaultValueBoolean="true"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="barber_schedule" baseColumnNames="barber_id"
                                 constraintName="fk_barber_schedule_barber"
                                 referencedTableName="barber" referencedColumnNames="id_barber"/>
    </changeSet>

    <!-- Tabela Notification -->
    <changeSet id="2.0-create-notification-table" author="gobarber">
        <createTable tableName="notification">
            <column name="id_notification" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="client_id" type="BIGINT"/>
            <column name="barber_id" type="INTEGER"/>
            <column name="appointment_id" type="BIGINT"/>
            <column name="type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="channel" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="title" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="message" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)" defaultValue="PENDING">
                <constraints nullable="false"/>
            </column>
            <column name="sent_at" type="TIMESTAMP"/>
            <column name="read_at" type="TIMESTAMP"/>
            <column name="scheduled_for" type="TIMESTAMP"/>
            <column name="recipient_email" type="VARCHAR(255)"/>
            <column name="recipient_phone" type="VARCHAR(20)"/>
            <column name="external_message_id" type="VARCHAR(255)"/>
            <column name="retry_count" type="INTEGER" defaultValueNumeric="0"/>
            <column name="error_message" type="TEXT"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="notification" baseColumnNames="client_id"
                                 constraintName="fk_notification_client"
                                 referencedTableName="client" referencedColumnNames="id_client"/>
        <addForeignKeyConstraint baseTableName="notification" baseColumnNames="barber_id"
                                 constraintName="fk_notification_barber"
                                 referencedTableName="barber" referencedColumnNames="id_barber"/>
        <addForeignKeyConstraint baseTableName="notification" baseColumnNames="appointment_id"
                                 constraintName="fk_notification_appointment"
                                 referencedTableName="appointment" referencedColumnNames="id_appointment"/>

        <createIndex tableName="notification" indexName="idx_notification_client_status">
            <column name="client_id"/>
            <column name="status"/>
        </createIndex>
        <createIndex tableName="notification" indexName="idx_notification_scheduled">
            <column name="scheduled_for"/>
            <column name="status"/>
        </createIndex>
    </changeSet>

    <!-- Tabela WaitList -->
    <changeSet id="2.0-create-waitlist-table" author="gobarber">
        <createTable tableName="wait_list">
            <column name="id_wait_list" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="client_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="desired_time" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="desired_duration" type="INTEGER"/>
            <column name="preferred_barber_id" type="INTEGER"/>
            <column name="priority" type="VARCHAR(20)" defaultValue="NORMAL">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)" defaultValue="WAITING">
                <constraints nullable="false"/>
            </column>
            <column name="position" type="INTEGER"/>
            <column name="notes" type="TEXT"/>
            <column name="notified" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="notified_at" type="TIMESTAMP"/>
            <column name="expiration_time" type="TIMESTAMP"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="wait_list" baseColumnNames="client_id"
                                 constraintName="fk_waitlist_client"
                                 referencedTableName="client" referencedColumnNames="id_client"/>
        <addForeignKeyConstraint baseTableName="wait_list" baseColumnNames="preferred_barber_id"
                                 constraintName="fk_waitlist_barber"
                                 referencedTableName="barber" referencedColumnNames="id_barber"/>

        <createIndex tableName="wait_list" indexName="idx_waitlist_status_position">
            <column name="status"/>
            <column name="position"/>
        </createIndex>
    </changeSet>

    <!-- Tabela AuditLog -->
    <changeSet id="2.0-create-audit-log-table" author="gobarber">
        <createTable tableName="audit_log">
            <column name="id_audit" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="action_type" type="VARCHAR(30)">
                <constraints nullable="false"/>
            </column>
            <column name="entity_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="entity_id" type="BIGINT"/>
            <column name="old_value" type="TEXT"/>
            <column name="new_value" type="TEXT"/>
            <column name="username" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="ip_address" type="VARCHAR(45)"/>
            <column name="user_agent" type="VARCHAR(500)"/>
            <column name="request_url" type="VARCHAR(500)"/>
            <column name="http_method" type="VARCHAR(10)"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>

        <createIndex tableName="audit_log" indexName="idx_audit_entity">
            <column name="entity_type"/>
            <column name="entity_id"/>
        </createIndex>
        <createIndex tableName="audit_log" indexName="idx_audit_username">
            <column name="username"/>
        </createIndex>
        <createIndex tableName="audit_log" indexName="idx_audit_action">
            <column name="action_type"/>
        </createIndex>
        <createIndex tableName="audit_log" indexName="idx_audit_created">
            <column name="created_at"/>
        </createIndex>
    </changeSet>

    <!-- Adicionar client_id Ã  tabela appointment -->
    <changeSet id="2.0-add-client-to-appointment" author="gobarber">
        <addColumn tableName="appointment">
            <column name="client_id" type="BIGINT"/>
        </addColumn>
        <addForeignKeyConstraint baseTableName="appointment" baseColumnNames="client_id"
                                 constraintName="fk_appointment_client"
                                 referencedTableName="client" referencedColumnNames="id_client"/>
    </changeSet>

</databaseChangeLog>
